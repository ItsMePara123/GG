#!/bin/bash

# Para ASCII Art and Header
echo -e "\n\033[1;36m"
cat << "EOF"

  
  _____        _____            
 |  __ \ /\   |  __ \     /\    
 | |__) /  \  | |__) |   /  \   
 |  ___/ /\ \ |  _  /   / /\ \  
 | |  / ____ \| | \ \  / ____ \ 
 |_| /_/    \_\_|  \_\/_/    \_\
                                
 ðŸ¤ Framework Installer - github.com/ParaNoob123

EOF
echo -e "\033[0m"

# =========================
# PANEL UPDATE FIRST
# =========================
echo -e "\033[1;34mUpdating Pterodactyl Panel...\033[0m"
echo "-------------------------------------"

cd /var/www/pterodactyl || exit 1

panel_update_cmds=(
  "php artisan down"
  "curl -L https://github.com/pterodactyl/panel/releases/download/v1.11.11/panel.tar.gz | tar -xzv"
  "chmod -R 755 storage/* bootstrap/cache"
  "composer install --no-dev --optimize-autoloader"
  "php artisan view:clear"
  "php artisan config:clear"
  "php artisan migrate --seed --force"
  "chown -R www-data:www-data /var/www/pterodactyl/*"
  "php artisan queue:restart"
  "php artisan up"
)

for i in "${!panel_update_cmds[@]}"; do
  echo -e "\033[1;33m[Panel $((i+1))/10]\033[0m \033[0;35m${panel_update_cmds[$i]}\033[0m"
  eval "${panel_update_cmds[$i]}"
  if [ $? -ne 0 ]; then
    echo -e "\033[1;31mPanel update failed at step $((i+1)). Aborting.\033[0m"
    exit 1
  fi
done

echo -e "\033[1;32mPanel updated successfully âœ”\033[0m"
echo "-------------------------------------"

# =========================
# BLUEPRINT INSTALLATION
# =========================
echo -e "\033[1;34mStarting Installation of Blueprint.zip\033[0m"
echo "-------------------------------------"

commands=(
  "sudo apt-get install -y ca-certificates curl gnupg"
  "sudo mkdir -p /etc/apt/keyrings"
  "curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg"
  "echo \"deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main\" | sudo tee /etc/apt/sources.list.d/nodesource.list"
  "sudo apt-get update"
  "sudo apt-get install -y nodejs"
  "sudo npm i -g yarn"
  "cd /var/www/pterodactyl"
  "yarn"
  "sudo apt install -y zip unzip git curl wget"
  "wget \"\$(curl -s https://api.github.com/repos/BlueprintFramework/framework/releases/latest | grep 'browser_download_url' | cut -d '\"' -f 4)\" -O release.zip"
  "unzip release.zip"
  "chmod +x blueprint.sh"
  "bash blueprint.sh"
)

for i in "${!commands[@]}"; do
  echo -e "\033[1;33m[$((i+1))/14] Executing:\033[0m \033[0;35m${commands[$i]}\033[0m"
  eval "${commands[$i]}"
  if [ $? -ne 0 ]; then
    echo -e "\033[1;31mError occurred at step $((i+1)). Aborting installation.\033[0m"
    exit 1
  fi
done

# =========================
# DONE
# =========================
echo -e "\n\033[1;32m-------------------------------------\033[0m"
echo -e "\033[1;32mPanel updated + Blueprint installed successfully! ðŸŽ‰\033[0m"
echo -e "\033[1;35m           Made by Para\033[0m"
echo -e "\033[1;35m       github.com/Para\033[0m"
echo -e "\033[1;32m-------------------------------------\033[0m"
