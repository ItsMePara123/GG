#!/bin/bash
# ==================================================
# üí≥ PAYMENTER AUTO INSTALLER
# Clean UI ‚Ä¢ Emoji Styled ‚Ä¢ Production Ready
# ==================================================

# ---------------- COLORS ----------------
C_RESET="\e[0m"
C_RED="\e[1;31m"
C_GREEN="\e[1;32m"
C_YELLOW="\e[1;33m"
C_BLUE="\e[1;34m"
C_PURPLE="\e[1;35m"
C_CYAN="\e[1;36m"
C_WHITE="\e[1;37m"
C_GRAY="\e[1;90m"

line(){ echo -e "${C_GRAY}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${C_RESET}"; }
step(){ echo -e "${C_BLUE}‚ûú $1${C_RESET}"; }
ok(){ echo -e "${C_GREEN}‚úî $1${C_RESET}"; }
warn(){ echo -e "${C_YELLOW}‚ö† $1${C_RESET}"; }
err(){ echo -e "${C_RED}‚úñ $1${C_RESET}"; }

# ---------------- HEADER ----------------
clear
line
echo -e "${C_PURPLE}üí≥ Paymenter Auto Installer${C_RESET}"
echo -e "${C_GRAY}Fast ‚Ä¢ Secure ‚Ä¢ Production Ready${C_RESET}"
line
echo -e "${C_CYAN}üåê Domain Configuration${C_RESET}"
echo -e "${C_WHITE}Enter the domain you want for Paymenter${C_RESET}"
line

read -rp "$(echo -e "${C_YELLOW}‚û§ Domain (paymenter.example.com): ${C_RESET}")" DOMAIN

if [ -z "$DOMAIN" ]; then
  err "No domain entered. Exiting."
  exit 1
fi

ok "Domain set to: $DOMAIN"
sleep 1

# ---------------- SYSTEM PREP ----------------
step "Updating system & installing base packages"
apt update -y && apt install -y curl apt-transport-https ca-certificates gnupg unzip git tar sudo lsb-release

OS=$(lsb_release -is | tr '[:upper:]' '[:lower:]')

if [[ "$OS" == "ubuntu" ]]; then
    step "Detected Ubuntu ‚Äî adding PHP repository"
    apt install -y software-properties-common
    add-apt-repository -y ppa:ondrej/php
elif [[ "$OS" == "debian" ]]; then
    step "Detected Debian ‚Äî adding PHP repository"
    curl -fsSL https://packages.sury.org/php/apt.gpg | gpg --dearmor -o /usr/share/keyrings/sury-php.gpg
    echo "deb [signed-by=/usr/share/keyrings/sury-php.gpg] https://packages.sury.org/php/ $(lsb_release -cs) main" \
    > /etc/apt/sources.list.d/sury-php.list
fi

# Redis repo
curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis.gpg
echo "deb [signed-by=/usr/share/keyrings/redis.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" \
> /etc/apt/sources.list.d/redis.list

apt update -y

# ---------------- INSTALL STACK ----------------
step "Installing PHP, Nginx, MariaDB & Redis"
apt install -y \
php8.3 php8.3-{cli,fpm,common,mysql,mbstring,bcmath,xml,zip,curl,gd,intl,redis} \
mariadb-server nginx redis-server cron

apt purge -y apache2* || true
apt autoremove -y
rm -rf /etc/apache2 /var/www/html

systemctl enable --now mariadb redis-server cron
ok "Core services running"

# ---------------- DOWNLOAD PAYMENTER ----------------
step "Downloading Paymenter"
mkdir -p /var/www/paymenter
cd /var/www/paymenter

curl -Lo paymenter.tar.gz https://github.com/paymenter/paymenter/releases/latest/download/paymenter.tar.gz
tar -xzf paymenter.tar.gz
chmod -R 755 storage/* bootstrap/cache/
chown -R www-data:www-data /var/www/paymenter

# ---------------- DATABASE ----------------
step "Configuring database"
DB_NAME="paymenter"
DB_USER="paymenteruser"
DB_PASS="yourPassword"

mysql -e "CREATE DATABASE ${DB_NAME};"
mysql -e "CREATE USER '${DB_USER}'@'127.0.0.1' IDENTIFIED BY '${DB_PASS}';"
mysql -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'127.0.0.1';"
mysql -e "FLUSH PRIVILEGES;"

ok "Database ready"

# ---------------- ENV SETUP ----------------
step "Configuring environment"
cp -n .env.example .env

sed -i "s|^APP_URL=.*|APP_URL=https://${DOMAIN}|g" .env
sed -i "s|^DB_DATABASE=.*|DB_DATABASE=${DB_NAME}|g" .env
sed -i "s|^DB_USERNAME=.*|DB_USERNAME=${DB_USER}|g" .env
sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${DB_PASS}|g" .env

php artisan key:generate --force
php artisan storage:link
php artisan migrate --force --seed
php artisan db:seed --class=CustomPropertySeeder

ok "Application initialized"

# ---------------- CRON ----------------
step "Setting up scheduler"
(crontab -l 2>/dev/null | grep -v paymenter/artisan; \
echo "* * * * * php /var/www/paymenter/artisan schedule:run >/dev/null 2>&1") | crontab -

# ---------------- SSL ----------------
step "Generating SSL certificate"
mkdir -p /etc/certs/paymenter
openssl req -new -newkey rsa:4096 -days 3650 -nodes -x509 \
-subj "/C=NA/ST=NA/L=NA/O=Paymenter/CN=${DOMAIN}" \
-keyout /etc/certs/paymenter/privkey.pem \
-out /etc/certs/paymenter/fullchain.pem

# ---------------- NGINX ----------------
step "Configuring Nginx"
cat <<EOF > /etc/nginx/sites-available/paymenter.conf
server {
    listen 80;
    server_name ${DOMAIN};
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${DOMAIN};

    root /var/www/paymenter/public;
    index index.php;

    ssl_certificate /etc/certs/paymenter/fullchain.pem;
    ssl_certificate_key /etc/certs/paymenter/privkey.pem;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF

ln -sf /etc/nginx/sites-available/paymenter.conf /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t && systemctl restart nginx
ok "Nginx online"

# ---------------- QUEUE WORKER ----------------
step "Starting queue worker"
cat <<EOF > /etc/systemd/system/paymenter.service
[Unit]
Description=Paymenter Queue Worker

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/paymenter/artisan queue:work

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now paymenter.service
ok "Queue worker running"

# ---------------- ADMIN ----------------
step "Create admin account"
php artisan app:init
php artisan app:user:create

# ---------------- DONE ----------------
line
echo -e "${C_GREEN}üéâ Paymenter Installed Successfully!${C_RESET}"
line
echo -e "${C_CYAN}üåê URL      : ${C_WHITE}https://${DOMAIN}${C_RESET}"
echo -e "${C_CYAN}üóÑ DB User : ${C_WHITE}${DB_USER}${C_RESET}"
echo -e "${C_CYAN}üîë DB Pass : ${C_WHITE}${DB_PASS}${C_RESET}"
line
echo -e "${C_PURPLE}üöÄ Panel is live ‚Äî enjoy.${C_RESET}"
line
