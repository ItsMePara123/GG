#!/usr/bin/env bash
set -euo pipefail

# ===========================
#  ğŸ’³ Paymenter Auto Installer
#  With Enhanced UI & Final Summary
#  Made by Para ğŸ’œ
# ===========================

# Non-interactive apt
export DEBIAN_FRONTEND=noninteractive

# Colors
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'
PURPLE='\033[0;35m'; CYAN='\033[0;36m'; WHITE='\033[1;37m'; NC='\033[0m'
BOLD='\033[1m'

# -------- Header --------
print_header() {
    clear
    echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘${WHITE}           ğŸ’° Paymenter Auto-Installer By Para${PURPLE}                     â•‘"
    echo -e "â•‘                 ${WHITE}With Enhanced UI${PURPLE}                      â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# -------- Status messages --------
msg() { echo -e "${BLUE}${BOLD}[~]${NC} $1"; }
ok()  { echo -e "${GREEN}${BOLD}[âœ“]${NC} $1"; }
err() { echo -e "${RED}${BOLD}[âœ—]${NC} $1"; exit 1; }
warn(){ echo -e "${YELLOW}${BOLD}[!]${NC} $1"; }

# -------- Loading bar --------
progress_bar() {
    local duration=$1; local steps=28
    local step_delay=$(echo "scale=3; $duration/$steps" | bc -l 2>/dev/null || echo "0.1")
    echo -ne "${CYAN}["
    for ((i=0;i<steps;i++)); do echo -ne "â–ˆ"; sleep $step_delay; done
    echo -e "]${NC}"
}

# -------- Start --------
print_header
msg "Checking root permissions..."
[[ "$(id -u)" != 0 ]] && err "Run as root!"
ok "Root confirmed"

echo ""
echo -e "${CYAN}${BOLD}Domain Configuration${NC}"
read -rp "$(echo -e "${YELLOW}â¤ Enter domain (ex: billing.example.com): ${NC}")" DOMAIN
[[ -z "$DOMAIN" ]] && err "Domain cannot be empty!"

ok "Domain set: ${WHITE}$DOMAIN${NC}"

# -------- Vars --------
WEB_ROOT="/var/www/paymenter"
SERVICE_PATH="/etc/systemd/system/paymenter.service"
NGINX_CONF="/etc/nginx/sites-available/paymenter.conf"
CERT_DIR="/etc/certs/paymenter"
DB_NAME="paymenter"
DB_USER="paymenteruser"
DB_PASS="yourPassword"

msg "Starting installation..."
sleep 1

# -------- OS Check --------
msg "Detecting OS..."
. /etc/os-release
[[ "$ID" != "ubuntu" && "$ID" != "debian" ]] && err "Only Ubuntu/Debian supported"
ok "Detected: $ID $VERSION_CODENAME"

# -------- Packages --------
msg "Updating packages..."
apt update >/dev/null 2>&1 &
progress_bar 3

msg "Installing required dependencies..."
apt -y install software-properties-common curl apt-transport-https ca-certificates gnupg lsb-release >/dev/null 2>&1 &
progress_bar 5

if [[ "$ID" == "ubuntu" ]]; then
    msg "Adding PHP repo..."
    add-apt-repository -y ppa:ondrej/php >/dev/null 2>&1
fi

apt update >/dev/null 2>&1 &
progress_bar 3

msg "Installing PHP, Nginx, MariaDB, Redis..."
apt -y install php8.3 php8.3-{common,cli,gd,mysql,mbstring,bcmath,xml,fpm,curl,zip,intl,redis} \
        mariadb-server nginx tar unzip git redis-server cron openssl >/dev/null 2>&1 &
progress_bar 10
ok "Packages installed"

systemctl enable --now mariadb nginx php8.3-fpm redis-server cron

# -------- Paymenter --------
msg "Downloading Paymenter..."
mkdir -p "$WEB_ROOT"; cd "$WEB_ROOT"
curl -fsSL -o p.tar.gz https://github.com/paymenter/paymenter/releases/latest/download/paymenter.tar.gz \
    || err "Download failed"
tar -xzf p.tar.gz && rm p.tar.gz
ok "Paymenter downloaded"

msg "Database setup..."
mariadb <<EOF
CREATE DATABASE ${DB_NAME};
CREATE USER '${DB_USER}'@'127.0.0.1' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF
ok "Database & user created"

# -------- Env --------
msg "Configuring .env..."
cp -n .env.example .env
sed -i "s|APP_URL=.*|APP_URL=https://${DOMAIN}|" .env
sed -i "s|DB_DATABASE=.*|DB_DATABASE=${DB_NAME}|" .env
sed -i "s|DB_USERNAME=.*|DB_USERNAME=${DB_USER}|" .env
sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${DB_PASS}|" .env
ok ".env updated"

# -------- Composer --------
msg "Installing composer & PHP deps..."
command -v composer >/dev/null 2>&1 || (curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer)
composer install --no-dev --optimize-autoloader >/dev/null 2>&1 &
progress_bar 15
ok "Composer install done"

# -------- Laravel --------
msg "Running Laravel setup..."
php artisan key:generate --force >/dev/null
php artisan migrate --force --seed >/dev/null
php artisan storage:link >/dev/null || true
ok "Laravel setup completed"

# -------- Permissions --------
msg "Fixing permissions..."
chown -R www-data:www-data "$WEB_ROOT"
chmod -R 755 "$WEB_ROOT"/storage "$WEB_ROOT"/bootstrap/cache
ok "Permissions fixed"

# -------- Cron --------
msg "Configuring cron..."
( crontab -l 2>/dev/null | grep -v -F 'artisan schedule:run' ; echo "* * * * * php ${WEB_ROOT}/artisan schedule:run >/dev/null 2>&1" ) | crontab -
ok "Cron installed"

# -------- Queue Worker --------
msg "Creating systemd worker..."
cat > "$SERVICE_PATH" <<EOF
[Unit]
Description=Paymenter Queue Worker

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php $WEB_ROOT/artisan queue:work --sleep=3 --tries=3

[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload && systemctl enable --now paymenter.service
ok "Queue worker active"

# -------- SSL --------
msg "Generating SSL..."
mkdir -p "$CERT_DIR"
openssl req -new -newkey rsa:4096 -days 3650 -nodes -x509 \
  -subj "/CN=${DOMAIN}" -keyout "$CERT_DIR/privkey.pem" -out "$CERT_DIR/fullchain.pem" >/dev/null 2>&1
ok "SSL created (self-signed)"

# -------- Nginx --------
msg "Configuring Nginx..."
cat > "$NGINX_CONF" <<EOF
server {
    listen 80;
    server_name ${DOMAIN};
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${DOMAIN};
    root $WEB_ROOT/public;

    ssl_certificate $CERT_DIR/fullchain.pem;
    ssl_certificate_key $CERT_DIR/privkey.pem;

    index index.php;
    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
        include fastcgi_params;
    }
}
EOF

rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/paymenter.conf

nginx -t >/dev/null 2>&1 || err "Nginx config error"
systemctl restart nginx
ok "Nginx configured"

# ---------------------------
#        FINAL OUTPUT
# ---------------------------
clear
echo -e "\033[0;35mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘            ğŸ’°  Paymenter Installation Complete! ğŸ‰            â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
echo ""

echo -e "\033[1;36mğŸ“Œ Your panel is now installed & ready!\033[0m"
echo ""

echo -e "\033[1;35mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
echo -e "\033[1;37mğŸŒ  URL:            \033[0;32mhttps://${DOMAIN}\033[0m"
echo -e "\033[1;37mğŸ“  Directory:      \033[0;32m${WEB_ROOT}\033[0m"
echo -e "\033[1;37mğŸ—„ï¸  Database Name:   \033[0;32m${DB_NAME}\033[0m"
echo -e "\033[1;37mğŸ‘¤  DB User:         \033[0;32m${DB_USER}\033[0m"
echo -e "\033[1;37mğŸ”‘  DB Password:     \033[0;32m${DB_PASS}\033[0m"
echo -e "\033[1;35mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
echo ""

echo -e "\033[1;33mâš ï¸  IMPORTANT SECURITY NOTES:\033[0m"
echo -e "   â€¢ Change the database password ASAP"
echo -e "   â€¢ Replace self-signed SSL with real HTTPS"
echo -e "   â€¢ Ensure your DNS is correctly pointed to this server"
echo ""

echo -e "\033[1;32mâœ¨ Everything is set! Start using Paymenter now.\033[0m"
echo ""

echo -e "\033[0;35mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘                       ğŸ’³ Happy Processing!                   â•‘"
echo -e "â•‘                      ğŸš€ Made with â¤ï¸ by Para                 â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
