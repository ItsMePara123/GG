#!/bin/bash

###################################################
# ğŸš€ MythicalDash Remastered Auto Installer
# âœ¨ Made with â¤ï¸ by Para
# ğŸ‘‘ GitHub: https://github.com/ParaNoob123
###################################################

###################################################
# ğŸŸ¢ FIRST PRIORITY â€” DOMAIN INPUT BEFORE ANYTHING
###################################################
clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ MythicalDash Remastered Auto Installer"
echo "âœ¨ Made with â¤ï¸ by Para"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
read -p "ğŸŒ Enter your Domain (example: panel.example.com): " DOMAIN

if [ -z "$DOMAIN" ]; then
    echo ""
    echo "âŒ Domain required â€” Installation aborted!"
    exit 1
fi

echo ""
echo "âœ… Domain set to: $DOMAIN"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
sleep 2

###################################################
# ğŸ” AUTO OS DETECT
###################################################
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
else
    echo "âŒ Failed to detect OS."
    exit 1
fi

if [[ "$OS" != "ubuntu" && "$OS" != "debian" ]]; then
    echo "âŒ This installer works only on Ubuntu/Debian"
    exit 1
fi

###################################################
# ğŸ”„ UPDATE & INSTALL DEPENDENCIES
###################################################
apt update && apt upgrade -y
apt -y install software-properties-common curl apt-transport-https ca-certificates gnupg

if [ "$OS" == "ubuntu" ]; then
    LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php
    apt-add-repository universe
else
    curl -fsSL https://packages.sury.org/php/apt.gpg | gpg --dearmor -o /usr/share/keyrings/php.gpg
    echo "deb [signed-by=/usr/share/keyrings/php.gpg] https://packages.sury.org/php/ $VERSION_CODENAME main" \
    | tee /etc/apt/sources.list.d/php.list
fi

apt update

apt -y install \
php8.3 php8.3-{common,cli,gd,mysql,mbstring,bcmath,xml,fpm,curl,zip,redis} \
mariadb-server nginx tar unzip zip git redis-server make dos2unix cron openssl screen

systemctl enable --now cron

###################################################
# ğŸ¼ COMPOSER
###################################################
curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

###################################################
# âš¡ DOWNLOAD + INSTALL PANEL
###################################################
mkdir -p /var/www/mythicaldash-v3
cd /var/www/mythicaldash-v3 || exit 1

curl -Lo MythicalDash.zip https://github.com/MythicalLTD/MythicalDash/releases/latest/download/MythicalDash.zip
unzip -o MythicalDash.zip
chown -R www-data:www-data /var/www/mythicaldash-v3/*

cd backend || exit 1
COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader

###################################################
# ğŸ¦ DATABASE SETUP
###################################################
DB="mythicaldash_remastered"
USER="mythicaldash_remastered"
PASS="parabhaiya"

mariadb -e "CREATE DATABASE $DB;"
mariadb -e "CREATE USER '$USER'@'127.0.0.1' IDENTIFIED BY '$PASS';"
mariadb -e "GRANT ALL PRIVILEGES ON $DB.* TO '$USER'@'127.0.0.1';"
mariadb -e "FLUSH PRIVILEGES;"

###################################################
# ğŸ”¥ PRODUCTION BUILD
###################################################
cd /var/www/mythicaldash-v3 || exit 1
make set-prod

###################################################
# â± CRON SETUP
###################################################
{ crontab -l 2>/dev/null | grep -v "mythicaldash-v3"; \
  echo "* * * * * bash /var/www/mythicaldash-v3/backend/storage/cron/runner.bash >> /dev/null 2>&1"; \
  echo "* * * * * php /var/www/mythicaldash-v3/backend/storage/cron/runner.php >> /dev/null 2>&1"; } | crontab -

clear
php mythicaldash setup
php mythicaldash migrate
php mythicaldash pterodactyl configure

###################################################
# ğŸ” SELF-SIGNED SSL
###################################################
mkdir -p /etc/certs/MythicalDash-Para
cd /etc/certs/MythicalDash-Para || exit 1

openssl req -new -newkey rsa:4096 -days 3650 -nodes -x509 \
-subj "/C=NA/ST=NA/L=NA/O=Para/CN=MythicalDash" \
-keyout privkey.pem -out fullchain.pem

###################################################
# ğŸ— NGINX CONFIG
###################################################
CONF="/etc/nginx/sites-available/MythicalDash-Para.conf"

cat <<EOF > $CONF
server {
    listen 80;
    server_name $DOMAIN;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    root /var/www/mythicaldash-v3/frontend/dist;
    index index.html;

    ssl_certificate /etc/certs/MythicalDash-Para/fullchain.pem;
    ssl_certificate_key /etc/certs/MythicalDash-Para/privkey.pem;

    location / {
        try_files \$uri \$uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:6000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }

    location /i/ {
        proxy_pass http://localhost:6000;
    }

    location /attachments {
        alias /var/www/mythicaldash-v3/backend/public/attachments;
    }
}

server {
    listen 6000;
    server_name localhost;

    root /var/www/mythicaldash-v3/backend/public;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF

ln -sf $CONF /etc/nginx/sites-enabled/
systemctl restart nginx

cd /var/www/mythicaldash-v3 || exit 1
chown -R www-data:www-data /var/www/mythicaldash-v3/*

php mythicaldash makeAdmin

###################################################
# âœ… DONE
###################################################
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ MythicalDash Installed Successfully!"
echo "ğŸŒ URL: https://$DOMAIN"
echo "ğŸ‘‘ Made with â¤ï¸ by Para"
echo "ğŸ”¥ Enjoy your panel!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
